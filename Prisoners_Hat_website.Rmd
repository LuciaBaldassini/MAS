---
title: "The Prisoners and Hats Riddle"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
  encoding=encoding,  
  output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author:
- Lucia Baldassini
- Dani&euml;lle Metz
- Julia Mol   
output: rmdformats::material
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Description of the riddle


<font face="apple chancery" color="olive"><center><i>You and other individuals have been captured by super-intelligent aliens! The aliens think agents look quite tasty, but - luckily for you - their civilization forbids eating highly logical and cooperative beings. Since the aliens are not sure whether you qualify, they decide to give you all a test to figure that out. 
The aliens tell you the following:</i> </center></font>


<p><center> "You will be placed in a line, facing forward and ordered from <i>tallest</i> to <i>shortest</i>. You will not be able to look behind you or step out of the line. <br>
Each of you will have either a <span style="color:blue">blue</span> or a <span style="color: red">red</span> hat (assigned randomly) and no one will be told how many of each colour hats there are. When I tell you to begin, each of you must guess the colour of their own hat, starting from the person in the back and moving down the line.
Know that we notice everything! So, do not even think of saying other words than <span style="color:blue">blue</span> or <span style="color: red">red</span> or signal something with intonation, for instance. <br><i><b>Else, you will all be eaten immediately! </b></i> 
<br>For you to stay spared, you are allowed to make up to one mistake at most. You are given a couple of minutes to discuss a strategy before we start."</center></p>


<!--<font color="olive"><center><i>Can you think of a strategy guaranteed to save everyone?</i> </center></font>
-->

# Strategy

The strategy to win this game and, hence, be freed by the aliens is to agree that the tallest agent says:
<ul>
<li> <span style="color:blue">"Blue"</span> to indicate that he sees an odd number of <span style="color:red">red</span> hats in front of him;</li>
<li>Or, <span style="color:red">"Red"</span> to indicate that he sees an even number of <span style="color:red">red</span> hats in front of him. </li>
</ul>

The tallest agents does not hear any information from another agent before he has to speak. Since he cannot be entirely sure about his own hat colour, he has to guess. This is not immediately a big problem, since the aliens allowed the agents to make one mistake. Since all other agents can say with full certainty which colour their hat is, there will not be made more than one mistake in total by the group. Namely, on the basis of hearing the previous answer(s) and seeing the hats in front of them, each agent can update his beliefs and determine his own hat colour. 

The game's goal is to have as many of the agents correctly guess their hat colour. The game is successfully played if at most one mistake is made. Therefore, since only the tallest agent is unsure of his answer, the game is always played successfully if the above-mentioned technique is applied.

<!--When the first agent has answered, the common knowledge of the others gets immediately adjusted. The number of possible worlds decrements when the previous agent(s) has indicated whether he sees an odd or even number of blue hats in front of him. Combining previous answers with an agent's current..  
-->

# Implementation

To solve the riddle, we built a system that runs from the command line. At the start, the system asks the user whether (s)he would like to read the description of the riddle or not. If so, a brief explanation of the riddle is viewed on the interface to inform the user. Furthermore, the user has the opportunity to decide the number of agents (at least two) and the manually assign the different hat colours to each of the agents. However, the option to let the system assign this randomly can also be chosen. An overview of the distribution of <span style="color:red">red</span> and <span style="color:blue">blue</span> hats among the agents is displayed .

Each agent is created from a class ```Agent()```, which stores the agent number (i.e. the shortest agent is agent number 1, which increases up to the tallest agent), colour of the hat and number of hats in front of the agent. The main programme contains the dialogues with the user and several functions. The functions ```assignRandomHat``` and ```assignUserHat``` assign a random hat colour and the colour, chosen by the user, to the agent, respectively. When the hats are assigned, the programme displays how the colours are distributed among the agents.

The kripke model is created from a class ```Kripke()```, which stores the agents and the various possible worlds. This class consists of a method called ```createKripkeModel``` that creates the initial Kripke model (i.e. the knowledge accessible to the agents before any announcement is made) in the form of a dictionary. Each agent represents a dictionary key and the values of each key are the worlds that are accessible for the agent before any announcement is made. The function considers all possible worlds, created with the ```itertools``` package, and the hat distribution chosen (stored in ```hats```). For each agent, ```hats``` is sliced so that it contains only the hats that each agent sees. Array slicing is an operation used to extract elements from an array and package them into another array. Also for each world ```w```, ```hats``` is sliced, so the array only contains the hats that are in front of the agent. Next, the two subarrays get compared. If these appear to be identical, they are added to the agent's list of accessible worlds. Hence, only the worlds representing what the agent sees are added. 

Next, the system enters the ```announcementLoop()``` in which each agent makes an announcement. After each announcement, the system stores all previous announcements into an array called ```commonKnowledge```. This array will be used later again to update the Kripke model. After the first announcement has been made, the knowledge of all the agents (except of the tallest one) is updated by eliminating either all the worlds containing an even number of red hats (if the tallest agent said <span style="color: blue">'blue'</span>) or an odd number of red hats (if the tallest agent said <span style="color: red">'red'</span>). After the knowledge is updated, the next agent in line deduces the colour of his hat. This is done in the ```deduceHatColour```. Here an agent checks if his hat colour is the same in all updated worlds. If this is the case, he announces it. The new announcement gets added to the common knowledge array accordingly. In the next iteration, the following agent in line (i.e. the third agent) will eliminate all the worlds, in which the second agent does not wear the hat with the colour announced previously, from his current knowledge. This process of eliminating worlds continues for all subsequent agents until all agent have made an announcement. 
During the announcement loop, the user has the option to view the updated Kripke model or not. 

When the announcement loop terminates, a function called ```checkRiddle()``` checks if at most one mistake has been made. This is done by comparing the ```commonKnowledge``` with the hat distribution input at the very beginning of the riddle. The comparison is done with ```numpy.sum```, which outputs the number of dissimilar items of two arrays. If the correct strategy had been implemented, this comparison should never output more than one unidentical item.

In the end, the system outputs a friendly message such as: ""Wow you are a highly intelligence specie, you will not be eaten!". 

A programme that solves this riddle can be found [here](https://github.com/LuciaBaldassini/MAS).

# Analysis

Depending on the number of agents and the hat colours assigned to each of them, there are multiple different scenarios possible. 
As an example, we will elaborate on the possible worlds in which three agents are participating in total. Each of the agents is either wearing a <span style="color: red">red</span> or <span style="color:blue">blue</span> hat. The following table indicates the 8 different scenarios that are possible in this situation. The arrows visualize the direction in which the particular agent is looking. T he colour of the cell represents the agent's hat colour. 

<table class="tg">
<caption><i>Table 1: The 8 different scenarios possible for 3 agents</i></caption>
<tbody>
<tr>
<th bgcolor="FFEFD5"><center><font color="black">Scenarios</font></center></th>
<th bgcolor="FFEFD5"><center><font color="black">Agent 3</font></center></th>
<th bgcolor="FFEFD5"><center><font color="black">Agent 2</font></center></th>
<th bgcolor="FFEFD5"><center><font color="black">Agent 1</font></center></th>
</tr>
<tr><td bgcolor="FFEFD5"><center><font color="black">1</font></center><br></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td></tr>

<tr><td bgcolor="FFEFD5"><center><font color="black">2</font></center><br></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
</tr>

<tr><td bgcolor="FFEFD5"><center><font color="black">3</font></center><br></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td></tr>

<tr><td bgcolor="FFEFD5"><center><font color="black">4</font></center><br></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td></tr>

<tr><td bgcolor="FFEFD5"><center><font color="black">5</font></center><br></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td></tr>

<tr><td bgcolor="FFEFD5"><center><font color="black">6</font></center><br></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td></tr>

<tr><td bgcolor="FFEFD5"><center><font color="black">7</font></center><br></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td></tr>

<tr><td bgcolor="FFEFD5"><center><font color="black">8</font></center><br></td>
<td bgcolor="0000FF"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td>
<td bgcolor="FF0000"><b><center><b><font color="white">=></font></b></center></b></td></tr>
</tbody>
</table>


### Example Analysis Scenario 4
In order to analyze the problem, we will present an example and go through all the agents' announcements and the changes to the Kripke model. This way, we can explore how the knowledge of the agents change. 

In our example, <span style="color:#00FF00">Agent 1</span> (the smallest agent) will be wearing a <span style="color:blue">blue</span> hat. <span style="color:#FF8000">Agent 2</span> (the middle agent) will also be wearing a <span style="color:blue">blue</span> hat. <span style="color:#007FFF">Agent 3</span> (the tallest agent) will be wearing a <span style="color:red">red</span> hat. 

```{r prisoners, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/Prisoners_rbb.png")
```

Initially, we could draw the following Kripke model: <span style="color:#007FFF">Agent 3</span> is unsure of only the colour of his own hat. The knowledge of <span style="color:#FF8000">Agent 2</span> contains worlds in which both his and <span style="color:#007FFF">Agent 3</span>'s hat colour vary. The knowledge of <span style="color:#00FF00">Agent 1</span> contains all possible combinations of <span style="color:blue">blue</span> and <span style="color:red">red</span>.   

```{r model no relations, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/hats_rbb_agent3,2,1.png")
```

Firstly, <span style="color:#007FFF">Agent 3</span> will announce <span style="color:red">red</span> to indicate that he sees an even number of <span style="color:red">red</span> hats (namely, 0). After the announcement, <span style="color:#FF8000">Agent 2</span> sees a <span style="color:blue">blue</span> hat in front of him so he eliminates all the worlds in which he is wearing a <span style="color:red">red</span> hat. In fact, it is not possible for him to wear a 
<span style="color:red">red</span> because, in this case, the tallest agent would have announced an odd number of red hats. Since this did not happen, <span style="color:#FF8000">Agent 2</span> deduces that his hat colour is <span style="color:blue">blue</span> and correctly announces it. 

<span style="color:#00FF00">Agent 1</span> also knows that there is an even number of <span style="color:red">red</span> hats, so he eliminates all the worlds in which he and <span style="color:#FF8000">Agent 2</span> are wearing different hat colours. In other words, he only keeps the worlds in which he and <span style="color:#FF8000">Agent 2</span> are wearing the same hat colour (either <span style="color:blue">blue</span> or <span style="color:red">red</span>).

Hence, the Kripke model is updated to: 


```{r model after 3, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/hats_rbb_after3.png")
```

<span style="color:#FF8000">Agent 2</span> announced that the colour of his hat is <span style="color:blue">blue</span>. Because of this announcement, <span style="color:#00FF00">Agent 1</span> now eliminates all the worlds in which <span style="color:#FF8000">Agent 2</span> is wearing a <span style="color:red">red</span> hat. 

The Kripke model is updated to: 

```{r model after 3 and 2, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/hats_rbb_after3,2.png")
```

Because <span style="color:#00FF00">Agent 1</span> knows that there is an even number of <span style="color:red">red</span> hats (from the first announcement) and that <span style="color:#FF8000">Agent 2</span> is wearing a <span style="color:blue">blue</span> hat (from the second announcement), he concludes that in the real world there are 0 <span style="color:red">red</span> hats and he announces that the colour of his own hat is <span style="color:blue">blue</span>, solving the riddle.  

</div>

# Further implementation

An addition made to the system is the scenario in which there are 10 hats, with 3 colours (<span style="color:red">red</span>, <span style="color:blue">blue</span> and <span style="color:yellow">yellow</span>) and a bug in the room. The actual total number of hats is irrelevant, but it was specified as such. 

In this scenario, our first strategy will not be able to solve the riddle, since specifying whether there is an odd or even number of red hats will not guarentee that any of the agents guesses their hat colour correctly. To add to the difficulty, a bug is added to the room in which the prisoners discuss their strategy together. For instance, if the prisoners agree on the strategy to all answer with the word <span style="color:red">red</span> (entailing that probably one third of them will have guessed correctly), the captors can sabotage them (e.g. giving none of the prisoners a red hat, so everyone guesses incorrectly).

The winning strategy is called the "checksum modulo-3" method. The prisoners agree on different numbers to represent each hat colour. For example: <span style="color:yellow">yellow</span> = 0, <span style="color:blue">blue</span> = 1 and <span style="color:red">red</span> = 2. Using these numbers, the  agents add up the numbers of the colours they see and perform a modulo (%) of 3 on the sum. Hence, obtaining either number 0, 1 or 2 and the corresponding colour will be the word he utters. In order to avoid negative numbers, all agents start with the number 30 and add the number, corresponding to the colour uttered by the taller agent(s), to what is called the "running tally". The next agent also calculates the sum of the hats in front of him, subtracts this number from the running tally and then performs a modulo of 3, such that they end up with their own hat colour number. The following agents again subtract this number from the current running tally such that when it is their turn, they all correctly call out the colour of their hat. 

As this method might be hard to imagine, we will provide a brief example of three agents, such that we can also visualize the Kripke model. In this new scenario, <span style="color:#007FFF">Agent 3</span> is wearing a <span style="color:yellow">yellow</span> hat, <span style="color:#FF8000">Agent 2</span> is wearing a <span style="color:red">red</span> hat and <span style="color:#00FF00">Agent 1</span> is wearing a <span style="color:blue">blue</span> hat. 

```{r, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/Prisoners_yrb.png")
```

Initially, we could draw the following Kripke model: <span style="color:#007FFF">Agent 3</span> is unsure of only the colour of his own hat. The knowledge of <span style="color:#FF8000">Agent 2</span> contains worlds in which both his and  <span style="color:#007FFF">Agent 3</span>'s hat colour vary. The knowledge of <span style="color:#00FF00">Agent 1</span> contains all possible combinations of <span style="color:yellow">yellow</span>, <span style="color:blue">blue</span> and <span style="color:red">red</span>. 

```{r, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/hats_yrb_agent3,2,1.png")
```

In this scenario, <span style="color:#007FFF">Agent 3</span> can see one <span style="color:red">red</span> hat (=2) and one <span style="color:blue">blue</span> hat (=1). He calculates the sum (2+1=3) and performs a modulo (3%3=0). He ends up with 0, which represents <span style="color:yellow">yellow</span>. Therefore, he says "<span style="color:yellow">yellow</span>". 

<span style="color:#FF8000">Agent 2</span> adds the current number (0) to the previously mentioned 30, resulting in 30. As he sees a <span style="color:blue">blue</span> hat, he subtracts the corresponding number from the running tally (30-1=29) and performs a modulo 3 (29%3=2), ending up with value 2. This means <span style="color:#FF8000">Agent 2</span> will, correctly, say "span style="color:red">red</span>". Before the utterance of <span style="color:#FF8000">Agent 2</span>, there was nothing for <span style="color:#00FF00">Agent 1</span> to update his Kripke model with. Therefore, only after the first utterance of <span style="color:#007FFF">Agent 3</span>, the Kripke model is updated to:

```{r, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/hats_yrb_after3.png")
```

<span style="color:#00FF00">Agent 1</span> also updated its running tally after <span style="color:#007FFF">Agent 3</span>'s turn, which is 30 at this point. After the utterance of <span style="color:#FF8000">Agent 2</span>, the value is adjusted to 1 after subtraction and applying the modulo of 3 to the value ((30-2)%3=1). This concludes that, according to this strategy, Agent 1 is wearing a <span style="color:blue">blue</span> hat. This results in the final Kripke model:
 

```{r, echo=FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("pictures/hats_yrb_after3,2.png")
```
